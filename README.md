<img src='https://github.com/SteamReviewSearch/.github/blob/main/image/SteamForYOU.jpg'>

# up-to-date

SteamForYou의 신규 업데이트 코드를 스케줄링을 통해 업데이트를 구현한 페이지입니다

# INFO

주요 기능으로는 
1. steam 게임의 업데이트
2. 게임들의 최신 리뷰 업데이트
3. 레디스 업데이트

가 있으며 스케줄링을 통하여 완전히 작동된 후 일주일이 지나고 작동되게 되어 있습니다.

# 코드 시나리오

1. node ./weekPlay.js 로 시작
2. schedule()함수가 작동하여 무한 반복문을 실행 이때 plan이라는 변수가 현재시간으로 시작하여 현재시간 보다 과거에 존재할 경우 실행
 - 2-1. 이때 plan에 일주일 뒤의 시간을 초기화
 - 2-2. mainThread클래스의 index_game()함수를 작동
3. index_game() 내부의 Worker_thread로 구현되고 있는 멀티 스레드 작동되어 각 스레드가 all_game_update.js라는 코드 실행
 - 3-1. exit이벤트를 이용한 무한 반복문을 사용하여 메인 스레드의 종료를 보류
 - 3-2. 각 스레드에서는 스레드 id를 이용하여 일분배
4. 엘라스틱에서 게임 리스트를 받아 steam open api를 사용하여 비교 후 없는 게임의 정보 탐색
 - 4-1. 필수 데이터가 없을 경우 게임에 대한 정보가 없는 경우, 나눌수 있는 데이터만 엘라스틱에 저장
 - 4-2. 필수 데이터가 존재할때 데이터를 받아 엘라스틱에 저장
5. 해당 받은 게임 리스트 중에 정보가 수정되는 데이터를 업데이트
 - 5-1. 해당 리스트에서 정보가 수정되어야하는 데이터를 판별할때 리뷰를 가지고 옴
 - 5-2. 필수 데이터가 null의 게임을 검증하여 필요한 경우 게임 정보 업데이트 진행
6. 각 스레드가 완료될때 메인 스레드에 exit이벤트를 전송하여 메인 스레드 종료 
7. 2번에서 다시 반복

# Trouble

해당 코드를 완성시키면서 고려되고 문제가 생긴 부분과 해결방법입니다.
1. steam 게임 open api의 한계점
- 문제 상황: 해당 문제의 경우에는 steam open api가 신규게임만을 제공하는 api가 없어 전체 리스트를 들고 와야하는 문제였습니다. 
이로 인해 엘라스틱의 데이터와 검증하는 과정에서 엘라스틱이 생각이상의 부하로 속도저하가 일어나 검색과 추천이 느려지는 현상이 발생
- 문제 해결: 원래 코드에서는 하나의 게임을 하나의 엘라스틱과 비교하면서 처리했다면 bulk라는 코드를 이용해서 많은 양의 게임들을 동시에 처리를 하여 검증에 의한 엘라스틱 속도 저하를 막았습니다.

2. steam 리뷰
- 문제 상황: 리뷰의 경우에는 최근 100개를 가지고 올 수 있는 open api가 존재하지만 1번과 같은 문제로 하나씩 확인하는 작업이 생각 이상의 자원을 사용하여 엘라스틱 속도저하의 원인이 되었다.
- 문제 해결: 원래 코드에서는 하나의 리뷰을 하나의 엘라스틱과 비교하면서 처리했다면 엘라스틱의 리뷰를 가지고와 신규 리뷰와 비교하여 한번에 bulk라는 코드를 이용해서 많은 양의 리뷰들을 동시에 처리를 하여 엘라스틱 속도 저하를 막았습니다.

3. 캐싱 코드 문제
- 문제 상황: es내부의 정렬기능을 사용하려고 sort를 사용했으나 sort의 변수를 undefined으로 인식하는 문제가 발생
- 문제 해결: sort 내부에 들어가는 변수 형식이 배열 내부의 오브젝트임을 파악, 이 부분을 수정하여 해결했습니다.

